#!/bin/bash

set -xe

REDIS_PROVIDER_URL=$(bin/redis-info)

# This sources POSTGRES_* env vars.
source bin/postgresql-info

HOSTIP=$(/sbin/ifconfig eth0 | grep "inet addr" | awk -F: '{print $2}' | awk '{print $1}')
echo $POSTGRES_HOST
echo $POSTGRES_PORT

DISCOURSE_HOST=${DISCOURSE_HOST:=discourse.example.com}

if [ -e .postmark-api-key ]; then
    export POSTMARK_API_KEY=$(cat .postmark-api-key)
fi

START_DISCOURSE="sudo docker run \
     -e REDIS_PROVIDER_URL=$REDIS_PROVIDER_URL \
     -e POSTGRES_HOST=$HOSTIP -e POSTGRES_PORT=$POSTGRES_PORT \
     -e POSTMARK_API_KEY=$POSTMARK_API_KEY \
     -e DISCOURSE_HOST=$DISCOURSE_HOST \
     -v $(pwd)/data/discourse-public:/discourse/public"

if [ "$@" = "web" ]; then
    START_DISCOURSE="$START_DISCOURSE -p :3000"
fi

exec $START_DISCOURSE srid/discourse $@
