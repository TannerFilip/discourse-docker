#!/bin/bash

set -xe

REDIS_PROVIDER_URL=$(bin/redis-info)

# This sources POSTGRES_* env vars.
source bin/postgresql-info

echo $POSTGRES_HOST
echo $POSTGRES_PORT

START_DISCOURSE="sudo docker run -e REDIS_PROVIDER_URL=$REDIS_PROVIDER_URL -e POSTGRES_HOST=$POSTGRES_HOST -e POSTGRES_PORT=$POSTGRES_PORT \
     -v $(pwd)/data/discourse-public:/discourse/public"

if [ -z "$1" ]; then
    echo "Running Discourse server"
    $START_DISCOURSE -p :3000 srid/discourse \
        /discourse/docker/start.sh 'bundle exec rails s'
elif [ "$1" -eq "setup" ]; then
    echo "Setting up discourse"
    $START_DISCOURSE srid/discourse "/discourse/docker/setup.sh"
else
    echo "Running arbitrary command: '$1'"
    $START_DISCOURSE srid/discourse /discourse/docker/start.sh "$@"
fi

