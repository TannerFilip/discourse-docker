#!/bin/bash

set -xe

REDIS_PROVIDER_URL=$(bin/redis-info)

# This sources POSTGRES_* env vars.
source bin/postgresql-info

echo $POSTGRES_HOST
echo $POSTGRES_PORT

DISCOURSE_HOST=${DISCOURSE_HOST:=discourse.example.com}

if [ -e .postmark-api-key ]; then
    export POSTMARK_API_KEY=$(cat .postmark-api-key)
fi

START_DISCOURSE="sudo docker run -e REDIS_PROVIDER_URL=$REDIS_PROVIDER_URL -e POSTGRES_HOST=$POSTGRES_HOST -e POSTGRES_PORT=$POSTGRES_PORT \
     -e POSTMARK_API_KEY=$POSTMARK_API_KEY \
     -e DISCOURSE_HOST=$DISCOURSE_HOST \
     -v $(pwd)/data/discourse-public:/discourse/public"

if [ -z "$1" ]; then
    echo "Running Discourse server"
    exec $START_DISCOURSE -p :3000 srid/discourse \
        /discourse/docker/start.sh 'bundle exec rails s'
elif [ "$1" = "setup" ]; then
    echo "Setting up discourse"
    exec $START_DISCOURSE srid/discourse "/discourse/docker/setup.sh"
else
    echo "Running arbitrary command: '$1'"
    exec $START_DISCOURSE srid/discourse /discourse/docker/start.sh "$@"
fi

